---
title: "Container Data Collection Using Azure Managed Service for Prometheus"
---

You can use the Azure Managed Service for Prometheus (AzMP) for container data collection. Data collection can be configured in 2 ways:

* [Prometheus-Enabled AKS Cluster](#AKS-Cluster)—This method is recommended for ease of setup. You can enable metrics collection from your AKS clusters and send the data to your Azure Monitor Prometheus workspace.
<Accordion title="Figure: Data Collection Using Azure Monitor with Managed Prometheus">
<Frame>![](/images/docs/WebHelp_Densify_Cloud/Content/Resources/Images/Cirba_DC_for_Public_Cloud/03000277.png)</Frame>
</Accordion>

One limitation is that the default AKS monitoring stack does not collect all of the metrics required by Densify for its analysis. A script, setup-azmp-aks-cluster.sh is provided to address this issue.

Additionally, you need to configure an Azure service principal and give it the required permissions to access to run PromQL queries against the AzMP API. Another script, register-app-create-secret.sh to automate this process.

* Remote-write from Self-Managed Prometheus—This method allows you to configure your own Prometheus stack and use its remote-write protocol to send collected data an Azure Monitor Workspace. See [remote-write protocol to an Azure Monitor Workspace](https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/prometheus-remote-write-virtual-machines?tabs=managed-identity) for configuration details.

You must also follow the general instructions to deploy the your exporter. Ensure that all of the metrics, required by Densify, are being collected. See [Required Prometheus Metrics](https://github.com/densify-dev/container-data-collection/tree/main/docs).

Before you begin, ensure you meet all of the prerequisite software and configuration requirements. See [Container Data Collection Prerequisites](./Container_Data_Collection_Prerequisites).

Navigate to https://github.com/densify-dev/container-data-collection/tree/main/multi-cluster/examples/azmp for instructions.

### Configuring the Data Forwarder Using configmap.yaml

Use the configmap.yaml to provide connectivity details for Densify, Prometheus and identity details for all of the clusters to be analyzed. If necessary, refe to the table below, for details of the required settings.

<Accordion title="Table: Data Forwarder Settings in configmap.yaml">
Table: Data Forwarder Settings in config.yaml

<table class="table_1" width="100%">
<col/>
<col/>
<col/>
<thead>
<tr>
<td class="td_2">
<p class="CiRBATableColumnText">Term</p>
</td>
<td class="td_2">
<p class="CiRBATableColumnText">Description</p>
</td>
<td class="td_2">
<p class="CiRBATableColumnText">Value</p>
</td>
</tr>
</thead>
<tr>
<td class="td_2" colspan="3">
<p class="CiRBATableColumnText">Forwarder Configuration </p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">scheme</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Specify the protocol  to be used to connect to the Densify REST API interface. Select <code>http</code> or <code>https</code>.</p>
</td>
<td class="td_3">
<p class="CiRBATableText">https</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">host</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Specify your <span class="mc-variable Document.Densify variable">Densify</span>instance details (e.g. myCompany.densify.com). You may need to specify <span class="mc-variable Document.Densify variable">Densify</span>  IP address.</p>
</td>
<td class="td_3">
<p class="CiRBATableText">&lt;host&gt;</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">port</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Specify the TCP/IP port used to connect to the <span class="mc-variable General.ProductName variable">Densify</span> server. </p>
<p class="CiRBATableText">You should not need to change this port number. </p>
</td>
<td class="td_3">
<p class="CiRBATableText">443</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">username</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Specify the <span class="mc-variable Document.Densify variable">Densify</span> user account that the Data Forwarder will use. This user must already exist in your <span class="mc-variable Document.Company variable">Densify</span> instance and have API access privileges. Contact <span class="mc-variable Document.Support variable"><a class="__cf_email__" data-cfemail="5a092f2a2a35282e1a1e3f3429333c2374393537" href="/cdn-cgi/l/email-protection">[email protected]</a></span> for the <span class="mc-variable Document.Densify variable">Densify</span> user and epassword required to connect to your <span class="mc-variable Document.Densify variable">Densify</span> instance. </p>
<p class="CiRBATableText">This user will be authenticated by the Densify server. </p>
</td>
<td class="td_3">
<p class="CiRBATableText">&lt;user name&gt;</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">password</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Specify the password associated with the user indicated above. Specify the password in plain text. </p>
</td>
<td class="td_3">
<p class="CiRBATableText">
</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">encrypted_password</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Specify encrypted password for the  user indicated above. The password must be 						encryptedand supersedes any value that has been specified in the password field, above.  </p>
<p class="CiRBATableText"> Typically, <span class="mc-variable Document.Support variable"><a class="__cf_email__" data-cfemail="70230500001f02043034151e031916095e131f1d" href="/cdn-cgi/l/email-protection">[email protected]</a></span> will provide a <span class="mc-variable General.ProductName variable">Densify</span> username and corresponding encrypted password when they setup your <span class="mc-variable General.ProductName variable">Densify</span> instance container data collection.</p>
<p class="CiRBATableText">Ensure that only one of the password options is enabled (i.e. uncommented).</p>
</td>
<td class="td_3">
<p class="CiRBATableText">&lt;encrypted password&gt;</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">endpoint</p>
</td>
<td class="td_3">
<p class="CiRBATableText">This is the connection endpoint for the API. You can leave the default value.</p>
</td>
<td class="td_3">
<p class="CiRBATableText">/api/v2/r</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">retry</p>
</td>
<td class="td_3">
<p class="CiRBATableText">The retry settings are optional and if not set specifically, then the default values are used. See <a class="RefToBookmarkNoPage MCXref xref xrefRefToBookmarkNoPage" href="./Container_Data_Forwarder_Optional_Configuration#Retry"><u>Configuring  Retry Connection Attempts</u></a> for setting details.</p>
</td>
<td class="td_3">
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">proxy</p>
</td>
<td class="td_3">
<p class="CiRBATableText">If you need to configure data collection through a proxy server, see <a class="RefToBookmarkNoPage MCXref xref xrefRefToBookmarkNoPage" href="./Container_Data_Forwarder_Optional_Configuration#Proxy"><u>Configuring  a Proxy Host</u></a>.</p>
</td>
<td class="td_3">
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">prefix</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Specify a prefix for the compressed filename. Use the cluster name or the Prometheus server name or another name to identify the cluster data. The prefix will be prepended to the transferred filenames.</p>
</td>
<td class="td_3">
<p class="CiRBATableText">&lt;zip file prefix&gt;</p>
</td>
</tr>
<tr>
<td class="td_2" colspan="3">
<p class="CiRBATableColumnText"> Prometheus Configuration</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">scheme</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Specify the protocol to be used to connect to the Prometheus interface. Select <code>http</code> or <code>https</code>.</p>
</td>
<td class="td_3">
<p class="CiRBATableText">https</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">host</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Specify the Prometheus hostname. </p>
<p class="CiRBATableText">The host details are available at the "Query Endpoint" in the Azure Monitor Workspace page on your Azure Portal. The host will be in format: &lt;AzMP workspace&gt;.&lt;Azure region&gt;.prometheus.monitor.azure.com.</p>
</td>
<td class="td_3">
<p class="CiRBATableText">&lt;Prometheus hostname&gt; </p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">port</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Specify your Prometheus service connection port. The default port is 9090. </p>
<p class="CiRBATableText">Ensure that this port is the web port associated with the Prometheus service name specified in <code>prometheus_address</code>.</p>
</td>
<td class="td_3">
<p class="CiRBATableText">9090</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">username</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Not used for this configuration. </p>
</td>
<td class="td_3">
<p class="CiRBATableText">&lt;username&gt;</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">password</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Not used for this configuration. </p>
</td>
<td class="td_3">
<p class="CiRBATableText">&lt;password&gt;</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">bearer_token</p>
</td>
<td class="td_3">
<p class="CiRBATableText">This setting is configured with a fixed name. Do not change the value entered here.</p>
</td>
<td class="td_3">
<p class="CiRBATableText">&lt;path&gt;</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">ca_cert</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Not used for this configuration. </p>
</td>
<td class="td_3">
<p class="CiRBATableText"> </p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">sigv4</p>
</td>
<td class="td_3">
<p class="CiRBATableText">This is not an option for AzMP. </p>
</td>
<td class="td_3">
<p class="CiRBATableText"> </p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">retry</p>
</td>
<td class="td_3">
<p class="CiRBATableText">The retry settings are optional and if not set specifically, then the default values are used. See <a class="RefToBookmarkNoPage MCXref xref xrefRefToBookmarkNoPage" href="./Container_Data_Forwarder_Optional_Configuration#Retry"><u>Configuring  Retry Connection Attempts</u></a> for setting details.</p>
</td>
<td class="td_3">
<p> </p>
</td>
</tr>
<tr>
<td class="td_2" colspan="3">
<p class="CiRBATableColumnText">Collection Settings</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText"><a name="include-list"></a>include</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Indicate which entity types for which data should be collected. This section is optional and if not set or empty then all of the following entity types are included.</p>
<table>
&lt;col/&gt;
&lt;col/&gt;
<tbody>
<tr>
<td>
<ul class="ul_1">
<li class="CiRBATableBullet">cluster</li>
<li class="CiRBATableBullet">container</li>
<li class="CiRBATableBullet">node</li>
</ul>
</td>
<td>
<ul class="ul_1">
<li class="CiRBATableBullet">nodegroup</li>
<li class="CiRBATableBullet">quota</li>
</ul>
</td>
</tr>
</tbody>
</table>
</td>
<td class="td_3">
<p class="CiRBATableText">true</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">interval </p>
</td>
<td class="td_3">
<p class="CiRBATableText">Optional: Specify the interval at which to collect data. Select one of days, hours or minutes. </p>
<p class="CiRBATableText">If you make changes here these interval settings must correspond with cronjob settings.</p>
</td>
<td class="td_3">
<p class="CiRBATableText">minutes</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">interval_size</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Optional: Specify the interval at which data is to be collected. If the interval is set to hours and interval_size is set to 1, then data is collected every hour.</p>
<p class="CiRBATableText">These interval settings need to correspond with your cronjob settings.</p>
</td>
<td class="td_3">
<p class="CiRBATableText">1</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">history</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Optional: </p>
</td>
<td class="td_3">
<p class="CiRBATableText">0</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">offset</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Optional: Specify the number of days, hours or minutes (based on the interval value) to offset data collection, backwards in time. <a name="kanchor259"></a></p>
</td>
<td class="td_3">
<p class="CiRBATableText">0</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">sample_rate</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Optional: Specify the  rate at which to collect samples within the specified interval. i.e. if the interval_size is set to 1 hour and sample rate is 5 seconds, then every hour 12 samples are collected.</p>
</td>
<td class="td_3">
<p class="CiRBATableText">5</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">node_group_list</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Optional: Specify a nodegroup label reference. By default,  the "node_group_list" parameter is commented out and the <span class="mc-variable Document.forwarder variable">data forwarder</span> use the values, listed: </p>
<ul class="ul_1">
<li class="CiRBATableBullet">label_cloud_google_com_gke_nodepool,</li>
<li class="CiRBATableBullet">label_eks_amazonaws_com_nodegroup,</li>
<li class="CiRBATableBullet">label_agentpool,</li>
<li class="CiRBATableBullet">label_pool_name,</li>
<li class="CiRBATableBullet">label_alpha_eksctl_io_nodegroup_name,</li>
<li class="CiRBATableBullet">label_kops_k8s_io_instancegroup</li>
<li class="CiRBATableBullet">label_karpenter_sh_nodepool</li>
</ul>
<p class="CiRBATableText">If  you want to specify a node group label that is not included in the following list, uncomment this parameter and specify your node group label. See <a class="RefToBookmarkNoPage MCXref xref xrefRefToBookmarkNoPage" href="./Container_Data_Forwarder_Optional_Configuration#Node_Grp_Label"><u>Configuring Node Group Collection</u></a> for more details.</p>
</td>
<td class="td_3">
<p> </p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">name</p>
</td>
<td class="td_3">
<p class="CiRBATableText">In a multi-cluster configuration, each cluster must have a unique name as well as a set of unique identifiers for each cluster.</p>
</td>
<td class="td_3">
<p class="CiRBATableText">&lt;name of first cluster&gt;</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">identifiers</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Specify identifiers as a map of Prometheus labels (name and value) to uniquely identify the cluster. If you omit the identifiers, only one cluster can be present in this list.</p>
</td>
<td class="td_3">
<p class="CiRBATableText">&lt;label name&gt;: &lt;label value&gt;</p>
</td>
</tr>
<tr>
<td class="td_2" colspan="3">
<p class="CiRBATableColumnText">Other</p>
</td>
</tr>
<tr>
<td class="td_3">
<p class="CiRBATableText">debug</p>
</td>
<td class="td_3">
<p class="CiRBATableText">Use this setting to turn debugging on/off.</p>
</td>
<td class="td_3">
<p class="CiRBATableText">&lt;false&gt;</p>
</td>
</tr>
</table>

</Accordion>
